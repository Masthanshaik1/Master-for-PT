pipeline {
    agent any

    environment {
        IMAGE_NAME = 'jmeter-with-plugins'  // Your Docker image
        TEST_REPO  = 'https://github.com/Masthanshaik1/Master-for-PT.git'  // Git repo with .jmx files
    }

    stages {

        stage('Checkout Tests') {
            steps {
                git branch: 'main',
                    credentialsId: 'GitHub-PAT',
                    url: TEST_REPO
            }
        }

  stage('Run JMeter Tests') {
            steps {
                script {
                    // Run Docker container with volume mapping to workspace
                    bat """
                    docker run --rm ^
                        -v "%WORKSPACE%:/tests" ^
                        ${IMAGE_NAME} ^
                        /opt/apache-jmeter-5.6.3/bin/jmeter ^
                        -n -t /tests/JMX/AB_SPRINT_4_50Urs_load.jmx ^
                        -l /tests/results.jtl
                    """
                    """
                }
            }
        }

 stage('Archive Results') {
            steps {
                archiveArtifacts artifacts: 'LoadTest/results.jtl, report/**', allowEmptyArchive: true
            }
        }

        stage('Push Results to GitHub') {
            steps {
                withCredentials([
                    usernamePassword(
                        credentialsId: 'GitHub-PAT',
                        usernameVariable: 'GIT_USER',
                        passwordVariable: 'GIT_PASS'
                    )
                ]) {
                    bat """
                    git config --global user.email "masthan.shaik@spectravisionit.com"
                    git config --global user.name "Masthanshaik1"

                    rem Pull latest changes first
                    git pull https://%GIT_USER%}%GIT_PASS%@github.com/Masthanshaik1/Master-for-PT.git main

                    rem Create results folder if not exists
                    if not exist results mkdir results

                    rem Append build number to results file and folder
                    set BUILD_NUM=%BUILD_NUMBER%
                    copy /Y LoadTest\\results.jtl results\\results_%BUILD_NUM%.jtl
                    xcopy /E /I /Y report results\\report_%BUILD_NUM%

                    git add results\\

                    git commit -m "Automated: Add latest JMeter results for build #%BUILD_NUM%" || echo Nothing to commit

                    git push https://%GIT_USER%:%GIT_PASS%@github.com/Masthanshaik1/Master-for-PT.git main
                    """
                }
            }
        }
    }
}





